name: Build and Release Gridfinity STLs

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'  # Matches version tags like v1.0.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t gridfinity-builder .

      - name: Create dist directory
        run: mkdir -p dist

      - name: Run variables.py to generate STL files into dist/
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace gridfinity-builder \
            bash -c "cd /workspace && python3 builder/variables.py bins.yaml && mv *.stl dist/ || true"

      - name: Commit and push STL files to dist/
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/*.stl
          git commit -m "Add generated STL files to dist [skip ci]" || echo "No changes to commit"
          git push